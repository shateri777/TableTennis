@page
@model TableTennis.Pages.Game.Create.TableTennisMatchModel
@{
    Func<int, string> FormatTime = (totalSeconds) =>
    {
        if (totalSeconds <= 0) return "00:00";
        int hours = totalSeconds / 3600;
        int minutes = (totalSeconds % 3600) / 60;
        int seconds = totalSeconds % 60;
        if (hours > 0)
        {
            return $"{hours:D2}:{minutes:D2}:{seconds:D2}";
        }
        return $"{minutes:D2}:{seconds:D2}";
    };
}

<div class="container mt-4">
    @* <h2 class="mb-4 text-center">Poängtavla</h2> *@

    @if (string.IsNullOrEmpty(Model.MatchFormVM.WinnerPlayer))
    {
        if (string.IsNullOrEmpty(Model.SetVM.WinnerPlayer))
        {

            <div class="tt-scoreboard">
                <div class="tt-mainrow">

                    <div class="tt-playercol">
                        <!-- HELA ÖVRE DELEN ÄR NU KLICKBAR -->
                        <form method="post" class="score-area-form" id="player1AddPointForm">
                            <input type="hidden" asp-for="@Model.Id" />
                            <input type="hidden" asp-for="@Model.MatchId" />
                            <input type="hidden" asp-for="@Model.SetVM.Player1Score" />
                            <input type="hidden" asp-for="@Model.SetVM.Player2Score" />
                            <input type="hidden" asp-for="@Model.SetCounter" />
                            <input type="hidden" asp-for="@Model.MatchFormVM.BestOfSets" />
                            <input type="hidden" asp-for="@Model.CompletedSetDurationSeconds" />
                            <input type="hidden" name="matchId" value="@Model.MatchId" />

                            <button asp-page-handler="AddPointToPlayer1" class="score-click-area" type="submit">
                                <div class="tt-score">@Model.SetVM.Player1Score</div>
                            </button>
                        </form>

                        <!-- MINUS-KNAPPEN -->
                        <form method="post" class="minus-form">
                            <input type="hidden" asp-for="@Model.Id" />
                            <input type="hidden" asp-for="@Model.MatchId" />
                            <input type="hidden" asp-for="@Model.SetVM.Player1Score" />
                            <input type="hidden" asp-for="@Model.SetVM.Player2Score" />
                            <input type="hidden" asp-for="@Model.SetCounter" />
                            <input type="hidden" asp-for="@Model.MatchFormVM.BestOfSets" />
                            <input type="hidden" asp-for="@Model.CompletedSetDurationSeconds" />
                            <input type="hidden" name="matchId" value="@Model.MatchId" />

                            @if (Model.SetVM.Player1Score > 0)
                            {
                                <button asp-page-handler="RemovePointPlayer1" class="tt-score-btn tt-minus" type="submit">-</button>
                            }
                            else
                            {
                                <button class="tt-score-btn tt-minus" type="button" disabled>-</button>
                            }
                        </form>
                    </div>


                    @* <div class="tt-playercol"> *@
                    @*     <form method="post" id="player1AddPointForm"> *@
                    @*         <input type="hidden" asp-for="@Model.Id" /> *@
                    @*         <input type="hidden" asp-for="@Model.MatchId" /> *@
                    @*         <input type="hidden" asp-for="@Model.SetVM.Player1Score" /> *@
                    @*         <input type="hidden" asp-for="@Model.SetVM.Player2Score" /> *@
                    @*         <input type="hidden" asp-for="@Model.SetCounter" /> *@
                    @*         <input type="hidden" asp-for="@Model.MatchFormVM.BestOfSets" /> *@
                    @*         <input type="hidden" asp-for="@Model.CompletedSetDurationSeconds" /> *@
                    @*         <input type="hidden" name="matchId" value="@Model.MatchId" /> *@
                    @*         <button asp-page-handler="AddPointToPlayer1" class="tt-score-btn tt-plus" type="submit">+</button> *@
                    @*     </form> *@
                    @*     <div class="tt-score">@Model.SetVM.Player1Score</div> *@
                    @*     <form method="post" class="minus-form"> *@
                    @*         <input type="hidden" asp-for="@Model.Id" /> *@
                    @*         <input type="hidden" asp-for="@Model.MatchId" /> *@
                    @*         <input type="hidden" asp-for="@Model.SetVM.Player1Score" /> *@
                    @*         <input type="hidden" asp-for="@Model.SetVM.Player2Score" /> *@
                    @*         <input type="hidden" asp-for="@Model.SetCounter" /> *@
                    @*         <input type="hidden" asp-for="@Model.MatchFormVM.BestOfSets" /> *@
                    @*         <input type="hidden" asp-for="@Model.CompletedSetDurationSeconds" /> *@
                    @*         <input type="hidden" name="matchId" value="@Model.MatchId" /> *@

                    @*         @if (Model.SetVM.Player1Score > 0) *@
                    @*         { *@
                    @*             <button asp-page-handler="RemovePointPlayer1" class="tt-score-btn tt-minus" type="submit">-</button> *@
                    @*         } *@
                    @*         else *@
                    @*         { *@
                    @*             <button class="tt-score-btn tt-minus" type="button" disabled>-</button> *@
                    @*         } *@

                    @*     </form> *@
                    @* </div> *@
                    <div class="tt-middle">
                        <div class="setContainer">
                            <div class="setScore">@Model.MatchFormVM.Player1WonSets</div>
                            <div class="setScore">@Model.MatchFormVM.Player2WonSets</div>
                        </div>
                        @* <div class="setScore">
                            <span>1</span>
                            <span class="space">:</span>
                            <span>2</span>
                        </div> *@

                        <div class="deuce-slot text-center">
                        @if (Model.IsDeuce)
                        {                          
                                <strong>DEUCE!</strong><br />                         
                        }
                        </div>

                        <div class="tt-cross">
                            <img src="https://static.wixstatic.com/media/47d5b4_dd3b09af552847cbbe7e0e351451ae16~mv2.gif"
                            alt="Ängbylogga"
                            class="logo-image" />
                        </div>
                        <div class="tt-time">
                            <span id="timer">00:00</span>
                        </div>
                        <div class="tt-setinfo">
                            Set: @Model.SetCounter av @Model.MatchFormVM.BestOfSets<br />
                        </div>
                    </div>
                    <div class="tt-playercol">
                        <!-- HELA ÖVRE DELEN ÄR NU KLICKBAR -->
                        <form method="post" class="score-area-form" id="player2AddPointForm">
                            <input type="hidden" asp-for="@Model.Id" />
                            <input type="hidden" asp-for="@Model.MatchId" />
                            <input type="hidden" asp-for="@Model.SetVM.Player1Score" />
                            <input type="hidden" asp-for="@Model.SetVM.Player2Score" />
                            <input type="hidden" asp-for="@Model.SetCounter" />
                            <input type="hidden" asp-for="@Model.MatchFormVM.BestOfSets" />
                            <input type="hidden" asp-for="@Model.CompletedSetDurationSeconds" />
                            <input type="hidden" name="matchId" value="@Model.MatchId" />

                            <button asp-page-handler="AddPointToPlayer2" class="score-click-area" type="submit">
                                <div class="tt-score">@Model.SetVM.Player2Score</div>
                            </button>
                        </form>

                        <!-- MINUS-KNAPPEN -->
                        <form method="post" class="minus-form">
                            <input type="hidden" asp-for="@Model.Id" />
                            <input type="hidden" asp-for="@Model.MatchId" />
                            <input type="hidden" asp-for="@Model.SetVM.Player1Score" />
                            <input type="hidden" asp-for="@Model.SetVM.Player2Score" />
                            <input type="hidden" asp-for="@Model.SetCounter" />
                            <input type="hidden" asp-for="@Model.MatchFormVM.BestOfSets" />
                            <input type="hidden" asp-for="@Model.CompletedSetDurationSeconds" />
                            <input type="hidden" name="matchId" value="@Model.MatchId" />

                            @if (Model.SetVM.Player2Score > 0)
                            {
                                <button asp-page-handler="RemovePointPlayer2" class="tt-score-btn tt-minus" type="submit">-</button>
                            }
                            else
                            {
                                <button class="tt-score-btn tt-minus" type="button" disabled>-</button>
                            }
                        </form>
                    </div>

                    @* <div class="tt-playercol"> *@
                    @*     <form method="post" id="player2AddPointForm"> *@
                    @*         <input type="hidden" asp-for="@Model.Id" /> *@
                    @*         <input type="hidden" asp-for="@Model.MatchId" /> *@
                    @*         <input type="hidden" asp-for="@Model.SetVM.Player1Score" /> *@
                    @*         <input type="hidden" asp-for="@Model.SetVM.Player2Score" /> *@
                    @*         <input type="hidden" asp-for="@Model.SetCounter" /> *@
                    @*         <input type="hidden" asp-for="@Model.MatchFormVM.BestOfSets" /> *@
                    @*         <input type="hidden" asp-for="@Model.CompletedSetDurationSeconds" /> *@
                    @*         <input type="hidden" name="matchId" value="@Model.MatchId" /> *@
                    @*         <button asp-page-handler="AddPointToPlayer2" class="tt-score-btn tt-plus" type="submit">+</button> *@
                    @*     </form> *@
                    @*     <div class="tt-score">@Model.SetVM.Player2Score</div> *@
                    @*     <form method="post" class="minus-form"> *@
                    @*         <input type="hidden" asp-for="@Model.Id" /> *@
                    @*         <input type="hidden" asp-for="@Model.MatchId" /> *@
                    @*         <input type="hidden" asp-for="@Model.SetVM.Player1Score" /> *@
                    @*         <input type="hidden" asp-for="@Model.SetVM.Player2Score" /> *@
                    @*         <input type="hidden" asp-for="@Model.SetCounter" /> *@
                    @*         <input type="hidden" asp-for="@Model.MatchFormVM.BestOfSets" /> *@
                    @*         <input type="hidden" asp-for="@Model.CompletedSetDurationSeconds" /> *@
                    @*         <input type="hidden" name="matchId" value="@Model.MatchId" /> *@

                    @*         @if (Model.SetVM.Player2Score > 0) *@
                    @*         { *@
                    @*             <button asp-page-handler="RemovePointPlayer2" class="tt-score-btn tt-minus" type="submit">-</button> *@
                    @*         } *@
                    @*         else *@
                    @*         { *@
                    @*             <button class="tt-score-btn tt-minus" type="button" disabled>-</button> *@
                    @*         } *@

                    @*     </form> *@
                    @* </div> *@
                </div>

                <div class="tt-bottomrow">
                    <div class="tt-player-info">
                        <div class="tt-player-name">
                            @Model.MatchFormVM.Player1FirstName @if (Model.SetVM.IsPlayer1Serve == true && Model.SetVM.WinnerPlayer == null)
                            {
                                <div class="tennisIconDiv @(Model.SetVM.IsPlayer1Serve ? "" : "invisible")"><i class="tennisIcon1 fa-solid fa-table-tennis-paddle-ball"></i></div>
                            }
                        </div>
                        

                        <div class="set-point-text @(Model.Player1Setpoint && !Model.Player1Matchpoint ? "" : "invisible")">
                            SET POINT!
                        </div>
                        <div class="set-point-text @(Model.Player1Matchpoint ? "" : "invisible")">
                            MATCH POINT! 🔥
                        </div>
                    </div>


                    <div class="tt-setinfo">
                        
                    </div>


                    <div class="tt-player-info">
                        <div class="tt-player-name2">
                            @if (Model.SetVM.IsPlayer1Serve == false && Model.SetVM.WinnerPlayer == null)
                            {
                                <div class="tennisIconDiv @(Model.SetVM.IsPlayer1Serve ? "invisible" : "")"><i class="tennisIcon2 fa-solid fa-table-tennis-paddle-ball"></i></div>
                            } @Model.MatchFormVM.Player2FirstName
                        </div>

                        <div class="set-point-text2 @(Model.Player2Setpoint && !Model.Player2Matchpoint ? "" : "invisible")">
                            SET POINT!
                        </div>
                        <div class="set-point-text2 @(Model.Player2Matchpoint ? "" : "invisible")">
                            MATCH POINT! 🔥
                        </div>
                    </div>
                    @* <div class="tt-player-info">
                        <div class="tt-player-name2">@Model.MatchFormVM.Player2FirstName</div>

                        @if (!Model.Player2Matchpoint)
                        {
                            <div class="set-point-text2 @(Model.Player2Setpoint ? "" : "invisible")">SET POINT!</div>
                        }
                        <div class="set-point-text2 @(Model.Player2Matchpoint ? "" : "invisible")">MATCH POINT! 🔥</div>
                    </div> *@
                </div>





                @* <div class="tt-bottomrow"> *@
                @*     <div class="tt-player-name">@Model.MatchFormVM.Player1FirstName</div> *@
                @*     @if (Model.SetVM.IsPlayer1Serve == true && Model.SetVM.WinnerPlayer == null) *@
                @*     { *@
                @*         <p><i class="fa-solid fa-table-tennis-paddle-ball"></i></p> *@
                @*     } *@
                @*     @if (Model.Player1Setpoint) *@
                @*     { *@
                @*         <div class="set-point">SET POINT!</div> *@
                @*     } *@
                @*     <div class="tt-setinfo"> *@
                @*         Set: @Model.SetCounter av @Model.MatchFormVM.BestOfSets<br /> *@

                @*     </div> *@
                @*     @if (Model.SetVM.IsPlayer1Serve == false && Model.SetVM.WinnerPlayer == null) *@
                @*     { *@
                @*         <p><i class="fa-solid fa-table-tennis-paddle-ball"></i></p> *@
                @*     } *@
                @*     <div class="tt-player-name">@Model.MatchFormVM.Player2FirstName</div> *@
                @*     @if (Model.Player2Setpoint) *@
                @*     { *@
                @*         <div class="set-point">SET POINT!</div> *@
                @*     }  *@
                @* </div> *@
            </div>
            @*    <span style="color: #e23a36; font-weight:bold;">
                            Server: @(Model.SetVM.IsPlayer1Serve ? Model.MatchFormVM.Player1FirstName : Model.MatchFormVM.Player2FirstName)
                        </span> *@
        }
        else
        {
            <section class="gender">

                <div class="gender-selection">
                    <h3>Vinnaren för detta set är @Model.SetVM.WinnerPlayer!</h3>
                    <form method="post">
                        <input type="hidden" asp-for="@Model.Id" />
                        <input type="hidden" asp-for="@Model.MatchId" />
                        <input type="hidden" asp-for="@Model.SetVM" />
                        <input type="hidden" asp-for="@Model.SetVM.Player1Score" />
                        <input type="hidden" asp-for="@Model.SetVM.Player2Score" />
                        <input type="hidden" asp-for="@Model.SetCounter" />
                        <input type="hidden" asp-for="@Model.MatchFormVM.BestOfSets" />
                        <button asp-page-handler="ContinueSet" class="submit-btn">Spela nästa set</button>
                    </form>
                </div>
            </section>
        }
    }
    else
    {
        <!-- Match-vinnare -->
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="alert alert-info text-center mt-4">
                    <h4>Vinnare för hela matchen: <b>@Model.MatchFormVM.WinnerPlayer</b>!</h4>
                    <a asp-page="/Game/Create/Index" class="btn btn-success mt-2">Starta ny match</a>
                    <a asp-page="/Index" class="btn btn-secondary mt-2">Till startsidan</a>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const timerElement = document.getElementById('timer');
            const matchId = "@Model.MatchId";
            const setCounter = "@Model.SetCounter";
            const timerKey = `set_timer_match_${matchId}_set_${setCounter}`;
            function updateHiddenTimeField(formElement) {
                const hiddenInput = formElement.querySelector('input[name="CompletedSetDurationSeconds"]');
                if (hiddenInput) {
                    const latestSeconds = sessionStorage.getItem(timerKey) || '0';
                    hiddenInput.value = latestSeconds;
                }
            }
            const p1Form = document.getElementById('player1AddPointForm');
            if (p1Form) {
                p1Form.addEventListener('submit', function() {
                    updateHiddenTimeField(this);
                });
            }
            const p2Form = document.getElementById('player2AddPointForm');
            if (p2Form) {
                p2Form.addEventListener('submit', function() {
                    updateHiddenTimeField(this);
                });
            }
            if (timerElement) {
                let seconds = 0;
                const storedSeconds = sessionStorage.getItem(timerKey);
                if (storedSeconds) {
                    seconds = parseInt(storedSeconds, 10);
                }
                function updateTimerDisplay() {
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    const formattedTime =
                        (minutes < 10 ? '0' + minutes : minutes) + ':' +
                        (remainingSeconds < 10 ? '0' + remainingSeconds : remainingSeconds);
                    timerElement.innerText = formattedTime;
                }
                function tick() {
                    seconds++;
                    updateTimerDisplay();
                    sessionStorage.setItem(timerKey, seconds.toString());
                }
                if(window.currentSetTimerIntervalId) clearInterval(window.currentSetTimerIntervalId);
                updateTimerDisplay();
                window.currentSetTimerIntervalId = setInterval(tick, 1000);
            }
        });
    </script>
}